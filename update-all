#!/usr/bin/env zsh
# ç³»ç»Ÿæ›´æ–°è„šæœ¬ - è‡ªåŠ¨æ›´æ–° Homebrewã€NPM åŒ…å’Œç›¸å…³å·¥å…·

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
RESET='\033[0m'

# é™é»˜æ¨¡å¼ - ä½¿ç”¨ -q æˆ– --quiet å‚æ•°å¯ç”¨
QUIET=false
if [[ "$1" == "-q" ]] || [[ "$1" == "--quiet" ]]; then
  QUIET=true
fi

# å¸¦é¢œè‰²æ‰“å°å‡½æ•° - ä»…åœ¨éé™é»˜æ¨¡å¼ä¸‹æ˜¾ç¤º
print_color() {
  local color=$1
  local message=$2
  if [[ "$QUIET" == "false" ]]; then
    echo -e "${color}${message}${RESET}"
  fi
}

# é™é»˜æ¨¡å¼å‹å¥½æ‰“å°å‡½æ•° - æ€»æ˜¯æ˜¾ç¤º
print_quiet() {
  local message=$1
  echo -e "${message}"
}

# å¼€å§‹è®¡æ—¶
START_TIME=$(date +%s)

# ASCII è‰ºæœ¯æ¨ªå¹…
echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ”„ SYSTEM UPDATE ğŸ”„                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${RESET}"

# é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸­æ–­è„šæœ¬
set +e

# æ£€æŸ¥ä¾èµ–é¡¹
if ! command -v brew &> /dev/null; then
  print_color "$RED" "âœ— Homebrew not found. Please install Homebrew first."
  exit 1
fi

if ! command -v npm &> /dev/null; then
  print_color "$RED" "âœ— npm not found. Please install Node.js first."
  exit 1
fi

# ============================================
# ğŸº Homebrew æ›´æ–°éƒ¨åˆ†
# ============================================
print_quiet "${CYAN}ğŸº Updating Homebrew...${RESET}"

if [[ "$QUIET" == "false" ]]; then
  echo ""
fi

# æ›´æ–° Homebrew
if brew update; then
  print_color "$GREEN" "  âœ“ Homebrew updated successfully"
else
  print_color "$RED" "  âœ— Homebrew update failed"
fi

# æ£€æŸ¥è¿‡æœŸçš„è½¯ä»¶åŒ…
OUTDATED_COUNT=$(brew outdated | wc -l | tr -d ' ')
if [[ "$QUIET" == "false" ]] && [[ $OUTDATED_COUNT -gt 0 ]]; then
  print_color "$YELLOW" "  â†’ $OUTDATED_COUNT outdated packages found"
  print_color "$BLUE" "  $(brew outdated | sed 's/^/    /')"
fi

# å‡çº§æ‰€æœ‰ formulae
print_color "$CYAN" "  â†’ Upgrading formulae..."
if brew upgrade --greedy; then
  UPGRADED_COUNT=$(brew outdated | wc -l | tr -d ' ')
  if [[ $UPGRADED_COUNT -eq 0 ]]; then
    print_color "$GREEN" "  âœ“ All formulae up-to-date"
  else
    print_color "$GREEN" "  âœ“ Formulae upgraded"
  fi
else
  print_color "$RED" "  âœ— Formulae upgrade failed"
fi

# æ¸…ç†æ—§ç‰ˆæœ¬
print_color "$CYAN" "  â†’ Cleaning up..."
if brew cleanup; then
  print_color "$GREEN" "  âœ“ Homebrew cleanup completed"
else
  print_color "$YELLOW" "  âš ï¸  Homebrew cleanup failed"
fi

# ============================================
# ğŸ“¦ Casks çŠ¶æ€æ˜¾ç¤ºéƒ¨åˆ†
# ============================================
# æ³¨æ„ï¼šbrew upgrade å·²ç»åŒæ—¶æ›´æ–°äº† formulae å’Œ casksï¼Œæ— éœ€å•ç‹¬æ›´æ–°
print_quiet ""
print_quiet "${CYAN}ğŸ“¦ Casks Status...${RESET}"

if [[ "$QUIET" == "false" ]]; then
  echo ""
fi

# ä»…æ˜¾ç¤º casks çŠ¶æ€ï¼Œä¸é‡å¤æ›´æ–°
CASKS=$(brew list --casks)
CASK_COUNT=$(echo "$CASKS" | grep -c '[^[:space:]]' || echo "0")

if [[ $CASK_COUNT -eq 0 ]]; then
  print_color "$YELLOW" "  â„¹ï¸  No casks installed"
else
  print_color "$GREEN" "  âœ“ $CASK_COUNT casks (already updated with brew upgrade)"
fi

# ============================================
# âš™ï¸  æ›´æ–°åæ“ä½œéƒ¨åˆ†
# ============================================
print_quiet ""
print_quiet "${CYAN}âš™ï¸  Running Post-Update Actions...${RESET}"

if [[ "$QUIET" == "false" ]]; then
  echo ""
fi

# ç¡®å®š HOMEBREW_PREFIX è·¯å¾„
if [ -z "$HOMEBREW_PREFIX" ]; then
  if [ -e "/opt/homebrew/bin/brew" ]; then
    HOMEBREW_PREFIX="/opt/homebrew"
  else
    HOMEBREW_PREFIX="/usr/local"
  fi
fi

# åˆ›å»º pyenv versions ç›®å½•
mkdir -p ~/.pyenv/versions

# é“¾æ¥ Python 2.x
if [ -e "$HOMEBREW_PREFIX/Cellar/python@2" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@2/2*(On[1]) ~/.pyenv/versions/
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@2/2*(On[1]) ~/.pyenv/versions/2
fi

# é“¾æ¥ Python 3.14
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.14" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.14/3*(On[1]) ~/.pyenv/versions/
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.14/3*(On[1]) ~/.pyenv/versions/3
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.14/3*(On[1]) ~/.pyenv/versions/3.14
fi

# é“¾æ¥ Python 3.13
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.13" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.13/3*(On[1]) ~/.pyenv/versions/3.13
fi

# é“¾æ¥ Python 3.12
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.12" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.12/3*(On[1]) ~/.pyenv/versions/3.12
fi

# é“¾æ¥ Python 3.11
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.11" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.11/3*(On[1]) ~/.pyenv/versions/3.11
fi

# é“¾æ¥ Python 3.10
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.10" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.10/3*(On[1]) ~/.pyenv/versions/3.10
fi

# é“¾æ¥ Python 3.9
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.9" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.9/3*(On[1]) ~/.pyenv/versions/3.9
fi

# é“¾æ¥ Python 3.8
if [ -e "$HOMEBREW_PREFIX/Cellar/python@3.8" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/python@3.8/3*(On[1]) ~/.pyenv/versions/3.8
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.14 (æ³¨æ„ï¼šä½¿ç”¨ ~/.pyenv/versions/3/bin)
if [ -e ~/.pyenv/versions/3 ]; then
  cd ~/.pyenv/versions/3/bin
  cp -Rf python3.14 python3
  cp -Rf python3 python
  cp -Rf pip3.14 pip3
  cp -Rf pip3 pip
  cp -Rf pydoc3.14 pydoc3
  cp -Rf python3.14-config python3-config
  cp -Rf idle3.14 idle3
  ln -nfs wheel3.14 wheel3
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.13
if [ -e ~/.pyenv/versions/3.13 ]; then
  cd ~/.pyenv/versions/3.13/bin
  cp -Rf python3.13 python3
  cp -Rf python3 python
  cp -Rf pip3.13 pip3
  cp -Rf pip3 pip
  cp -Rf pydoc3.13 pydoc3
  cp -Rf python3.13-config python3-config
  cp -Rf idle3.13 idle3
  ln -nfs wheel3.13 wheel3
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.12
if [ -e ~/.pyenv/versions/3.12 ]; then
  cd ~/.pyenv/versions/3.12/bin
  cp -Rf python3.12 python3
  cp -Rf python3 python
  cp -Rf pip3.12 pip3
  cp -Rf pip3 pip
  cp -Rf pydoc3.12 pydoc3
  cp -Rf python3.12-config python3-config
  cp -Rf idle3.12 idle3
  ln -nfs wheel3.12 wheel3
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.11
if [ -e ~/.pyenv/versions/3.11 ]; then
  cd ~/.pyenv/versions/3.11/bin
  cp -Rf python3.11 python3
  cp -Rf python3 python
  cp -Rf pip3.11 pip3
  cp -Rf pip3 pip
  cp -Rf pydoc3.11 pydoc3
  cp -Rf python3.11-config python3-config
  cp -Rf idle3.11 idle3
  ln -nfs wheel3.11 wheel3
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.10 (åªå¤åˆ¶ python å’Œ pip)
if [ -e ~/.pyenv/versions/3.10 ]; then
  cd ~/.pyenv/versions/3.10/bin
  cp -Rf python3.10 python3
  cp -Rf python3 python
  cp -Rf pip3.10 pip3
  cp -Rf pip3 pip
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.9 (åªå¤åˆ¶ python å’Œ pip)
if [ -e ~/.pyenv/versions/3.9 ]; then
  cd ~/.pyenv/versions/3.9/bin
  cp -Rf python3.9 python3
  cp -Rf python3 python
  cp -Rf pip3.9 pip3
  cp -Rf pip3 pip
fi

# åˆ›å»º bin æ–‡ä»¶é“¾æ¥ - Python 3.8 (åªå¤åˆ¶ python å’Œ pip)
if [ -e ~/.pyenv/versions/3.8 ]; then
  cd ~/.pyenv/versions/3.8/bin
  cp -Rf python3.8 python3
  cp -Rf python3 python
  cp -Rf pip3.8 pip3
  cp -Rf pip3 pip
fi

# é“¾æ¥ plantuml
mkdir -p $HOMEBREW_PREFIX/libexec
if [ -e "$HOMEBREW_PREFIX/Cellar/plantuml" ]; then
  ln -nfs $HOMEBREW_PREFIX/Cellar/plantuml/*/libexec/plantuml.jar $HOMEBREW_PREFIX/libexec/plantuml.jar
  print_color "$GREEN" "  âœ“ plantuml symlink updated"
else
  print_color "$YELLOW" "  â„¹ï¸  plantuml not installed"
fi

# ============================================
# ğŸ“¦ NPM å…¨å±€åŒ…æ›´æ–°éƒ¨åˆ†
# ============================================
print_quiet ""
print_quiet "${CYAN}ğŸ“¦ Updating NPM Global Packages...${RESET}"

if [[ "$QUIET" == "false" ]]; then
  echo ""
fi

print_color "$BLUE" "  â†’ Using official npm registry via --registry option"

# éœ€è¦æ›´æ–°çš„ NPM åŒ…åˆ—è¡¨
NPM_PACKAGES=(
  "@zed-industries/claude-code-acp"
  "opencode-ai"
  "@github/copilot-language-server"
  "@fission-ai/openspec@latest"
)

NPM_UPDATED=0
NPM_SKIPPED=0
NPM_FAILED=0

# è·å– NPM åŒ…ç‰ˆæœ¬çš„å‡½æ•°
get_npm_version() {
  local package=$1
  npm list -g "$package" --depth=0 | grep "$package@" | sed 's/.*@//'
}

# éå†å¹¶æ›´æ–°æ¯ä¸ª NPM åŒ…
for package in "${NPM_PACKAGES[@]}"; do
  # è·å–å½“å‰ç‰ˆæœ¬
  echo
  current_version=$(get_npm_version "$package")

  # å¦‚æœåŒ…æœªå®‰è£…ï¼Œè·³è¿‡
  if [[ -z "$current_version" ]]; then
    if [[ "$QUIET" == "false" ]]; then
      print_color "$YELLOW" "  â„¹ï¸  $package not installed, skipping"
    fi
    NPM_SKIPPED=$((NPM_SKIPPED + 1))
    echo '----------------------------------------------'
    continue
  fi

  if [[ "$QUIET" == "false" ]]; then
    print_color "$CYAN" "  ğŸ“Œ $package: v${current_version}"
  fi

  # æ›´æ–°åŒ…
  if npm install -g "$package" --registry=https://registry.npmjs.org/; then
    new_version=$(get_npm_version "$package")

    # æ¯”è¾ƒç‰ˆæœ¬å¹¶æ˜¾ç¤ºç»“æœ
    if [[ "$new_version" != "$current_version" ]]; then
      print_color "$GREEN" "  âœ“ Updated: v${current_version} â†’ v${new_version}"
      NPM_UPDATED=$((NPM_UPDATED + 1))
    else
      print_color "$YELLOW" "  âœ“ Already up-to-date: v${current_version}"
      NPM_SKIPPED=$((NPM_SKIPPED + 1))
    fi
  else
    print_color "$RED" "  âœ— Update failed for $package"
    NPM_FAILED=$((NPM_FAILED + 1))
  fi
  echo '----------------------------------------------'
done

# ============================================
# ğŸ° Bun å…¨å±€åŒ…æ›´æ–°éƒ¨åˆ†
# ============================================
print_quiet ""
print_quiet "${CYAN}ğŸ° Updating Bun Global Packages...${RESET}"

if [[ "$QUIET" == "false" ]]; then
  echo ""
fi

# æ£€æŸ¥ bun æ˜¯å¦å®‰è£…
if ! command -v bun &> /dev/null; then
  print_color "$YELLOW" "  â„¹ï¸  Bun not found, skipping"
else
  # éœ€è¦æ›´æ–°çš„ Bun åŒ…åˆ—è¡¨
  BUN_PACKAGES=(
    "ralph-tui"
  )

  BUN_UPDATED=0
  BUN_SKIPPED=0
  BUN_FAILED=0

  # è·å– Bun åŒ…ç‰ˆæœ¬çš„å‡½æ•°
  get_bun_version() {
    local package=$1
    bun pm ls -g 2>/dev/null | grep " $package@" | sed 's/.*@//'
  }

  # éå†å¹¶æ›´æ–°æ¯ä¸ª Bun åŒ…
  for package in "${BUN_PACKAGES[@]}"; do
    # è·å–å½“å‰ç‰ˆæœ¬
    echo
    current_version=$(get_bun_version "$package")

    # å¦‚æœåŒ…æœªå®‰è£…ï¼Œè·³è¿‡
    if [[ -z "$current_version" ]]; then
      if [[ "$QUIET" == "false" ]]; then
        print_color "$YELLOW" "  â„¹ï¸  $package not installed, skipping"
      fi
      BUN_SKIPPED=$((BUN_SKIPPED + 1))
      echo '----------------------------------------------'
      continue
    fi

    if [[ "$QUIET" == "false" ]]; then
      print_color "$CYAN" "  ğŸ° $package: v${current_version}"
    fi

    # æ›´æ–°åŒ…
    if bun install -g "$package"; then
      new_version=$(get_bun_version "$package")

      # æ¯”è¾ƒç‰ˆæœ¬å¹¶æ˜¾ç¤ºç»“æœ
      if [[ "$new_version" != "$current_version" ]]; then
        print_color "$GREEN" "  âœ“ Updated: v${current_version} â†’ v${new_version}"
        BUN_UPDATED=$((BUN_UPDATED + 1))
      else
        print_color "$YELLOW" "  âœ“ Already up-to-date: v${current_version}"
        BUN_SKIPPED=$((BUN_SKIPPED + 1))
      fi
    else
      print_color "$RED" "  âœ— Update failed for $package"
      BUN_FAILED=$((BUN_FAILED + 1))
    fi
    echo '----------------------------------------------'
  done
fi


# ============================================
# ğŸ“Š æ€»ç»“éƒ¨åˆ†
# ============================================
END_TIME=$(date +%s)
TOTAL_TIME=$((END_TIME - START_TIME))

# è®¡ç®—åˆ†é’Ÿå’Œç§’æ•°
MINUTES=$((TOTAL_TIME / 60))
SECONDS=$((TOTAL_TIME % 60))

print_quiet ""
echo -e "${MAGENTA}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ“Š UPDATE SUMMARY                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${RESET}"

# æ˜¾ç¤ºå„éƒ¨åˆ†çš„æ›´æ–°çŠ¶æ€
print_color "$GREEN" "  Homebrew: âœ“ Updated (includes formulae & casks)"
print_color "$GREEN" "  NPM: âœ“ $NPM_UPDATED updated, $NPM_SKIPPED skipped"
if command -v bun &> /dev/null; then
  print_color "$GREEN" "  Bun: âœ“ $BUN_UPDATED updated, $BUN_SKIPPED skipped"
fi

# å¦‚æœæœ‰å¤±è´¥çš„åŒ…ï¼Œæ˜¾ç¤ºè­¦å‘Š
if [[ $NPM_FAILED -gt 0 ]]; then
  print_color "$RED" "  NPM failures: $NPM_FAILED"
fi
if [[ $BUN_FAILED -gt 0 ]]; then
  print_color "$RED" "  Bun failures: $BUN_FAILED"
fi

# æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
if [[ $MINUTES -gt 0 ]]; then
  TIME_STR="${MINUTES}m ${SECONDS}s"
else
  TIME_STR="${SECONDS}s"
fi

print_color "$BLUE" "  â±ï¸  Total time: $TIME_STR"

# æœ€ç»ˆæ¶ˆæ¯
if [[ $NPM_FAILED -eq 0 ]]; then
  print_color "$GREEN" "  âœ¨ All updates completed!"
else
  print_color "$YELLOW" "  âš ï¸  Some updates encountered errors"
fi

echo ""
